{% extends "base.html" %}

{% block content %}

<br><br>

<form method="POST" action="{{ url_for('index.index') }}">
  <input type="hidden" name="category" value="{{ selected_category }}">
  <label for="sort_order">Sort by:</label>
  <select name="sort_order" id="sort_order">
      <option value="" {% if not sort_order %}selected{% endif %}>None</option>
      <option value="price_asc" {% if sort_order == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
      <option value="price_desc" {% if sort_order == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
      <option value="name_asc" {% if sort_order == 'name_asc' %}selected{% endif %}>Name: A to Z</option>
      <option value="name_desc" {% if sort_order == 'name_desc' %}selected{% endif %}>Name: Z to A</option>
  </select>
  <label for="keyword">Keyword(s):</label>
  <input type="text" name="keyword" id="keyword" value="{{ keyword }}">

  <button type="submit">Apply Filters</button>
</form>

<div class="products-grid container-fluid">
  {% for product in avail_products %}
  <div class="product-card">
    <div class="product-image">
      {% if product.image_path %}
      <img src="{{ url_for('static', filename=product.image_path) }}" alt="Image of {{ product.name }}">
      {% else %}
      <span>No image</span>
      {% endif %}
    </div>
    <div class="product-info">
      <h3 class="product-name">
        <a href="{{ url_for('index.product_detail', id=product.id) }}">{{ product.name }}</a>
      </h3>
      <p class="product-price">${{ product.price }}</p>
      <p class="product-description">{{ product.description }}</p>
      <p class="product-rating">
        Rating:
        {% set rating = product_ratings[product.id] if product_ratings[product.id] is not none else 0 %}
        
        {% for _ in range(rating | round(0, 'floor') | int) %}
            <span class="star">&#9733;</span> <!-- Filled star -->
        {% endfor %}
        
        {% for _ in range(5 - (rating | round(0, 'floor') | int)) %}
            <span class="star empty">&#9734;</span> <!-- Empty star -->
        {% endfor %}
        
        <span class="rating-value">({{ rating | round(1) }})</span>
      </p>
      <!-- <p class="product-category">Category: {{ product.category }}</p> -->
      <div class="product-actions">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('reviews.write_review', product_id=product.id) }}" class="btn btn-primary">Write a Review</a>
        {% else %}
        <span>Login to review</span>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination Controls -->
<div class="pagination">
  {% if page > 1 %}
      <a href="{{ url_for('index.index', page=page - 1, sort_order=sort_order, category=selected_category, keyword=keyword) }}" class="pagination-link previous">&laquo; Previous</a>
  {% endif %}

  <span class="page-info">Page {{ page }} of {{ total_pages }}</span>

  {% if page < total_pages %}
      <a href="{{ url_for('index.index', page=page + 1, sort_order=sort_order, category=selected_category, keyword=keyword) }}" class="pagination-link next">Next &raquo;</a>
  {% endif %}
</div>

<br><br>
{% if current_user.is_authenticated %}

<a class="btn btn-secondary" href="{{url_for('cartitem.cartitem')}}" role="button">My Cart</a>
<br><br>
<a class="btn btn-secondary" href="{{url_for('inventory.inventory')}}" role="button">My Inventory</a>

<br><br>

<h2>Your recent purchases:</h2>
<table class='table table-hover table-bordered container'>
  <thead class="thead-dark">
    <tr>
      <th scope="col">Purchase ID</th>
      <th scope="col">Product Name</th>
      <th scope="col">Price</th>
    </tr>
  </thead>
  <tbody>
    {% for purchase in purchase_history%}
      <tr>
        <th scope="row">{{purchase.id}}</th>
        <td>{{purchase.pid}}</td>
        <td>{{purchase.time_purchased}}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p><a href="{{ url_for('users.login') }}">Log in</a> to see your purchase history!</p>
{% endif %}

{% endblock %}
